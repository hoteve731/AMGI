/**
 * AMGI 애플리케이션을 위한 프롬프트 생성기
 * OpenAI API 호출을 위한 구조화된 프롬프트를 생성하는 함수들을 포함합니다
 */

/**
 * 콘텐츠 그룹 생성을 위한 시스템 프롬프트 생성
 * @param additionalMemory 사용자가 기억하고 싶은 내용에 대한 선택적 입력
 * @returns 시스템 프롬프트 문자열
 */
export function generateGroupsPrompt(additionalMemory?: string): string {
   return `당신은 텍스트를 학습하기 쉬운 기억 단위로 나누는 전문가입니다. 다음 지침을 반드시 따라주세요:
 
 1. 주어진 텍스트를 1~4개의 '그룹'으로 나누세요. 다음 기준을 따릅니다:
    - 텍스트가 **짧거나 핵심 주제가 1개인 경우**, 그룹은 **1개만** 생성합니다.
    - 텍스트가 길고 다양한 하위 주제를 포함한다면, **2~4개**의 그룹으로 나누되, **너무 작게 쪼개지 마세요**.
    - 너무 많은 그룹으로 나누는 것보다 적은 수의 의미 있는 그룹으로 나누는 것이 더 중요합니다.
 
 2. 각 그룹은 **서로 다른 핵심 주제**나 아이디어를 중심으로 구성해야 하며, 원문에서 그룹 단위로 잘라서 발췌한 '오리지널 소스'에는 해당 그룹의 원문 텍스트를 **어떠한 수정이나 요약 없이, 100% 그대로 복사하여** 포함해야 합니다.
 
 3. 각 그룹은 **기억카드 생성을 위한 정보 단위**로 적절해야 하며, 다음 조건을 만족해야 합니다:
    - 하나의 주제에 집중된 여러 문단(5~10문장)
    - 정보의 초점이 명확하고 정리되어 있음 (Focused, Precise)
    - 의미론적으로 연결된 내용들을 함께 그룹화 (Semantically Coherent)
 
 4. 각 그룹의 title은 반드시 다음 형식으로 작성합니다:
    - "{핵심 문장}을/를 기억하기"
    - '를' 또는 '을' 조사는 한국어 문법에 맞게 사용하세요.
    - 핵심 문장은 단순한 단어가 아니라 원문의 핵심 메시지를 담은 짧은 문장이어야 합니다. '을/를 기억하기' 문장에 자연스럽게 녹아들도록 하세요.
 
 5. 출력 형식을 반드시 아래와 같이 따라주세요:
 
 <그룹 1>
 제목: {핵심 문장}을/를 기억하기
 오리지널 소스: {원문 그대로 복사된 텍스트}
 
 <그룹 2>
 제목: {핵심 문장}을/를 기억하기
 오리지널 소스: {원문 그대로 복사된 텍스트}
 
 ...
 
 6. 각 그룹의 문장은 가능한 한 원문 흐름을 유지하도록 묶되, **설명이 끊기지 않도록 자연스럽게 연결된 문장들끼리 묶으세요**.
 7. 텍스트 전체를 균등하게 분배할 필요는 없습니다. 중요한 부분에 더 집중해도 됩니다.
 
 8. 그룹 수는 1개 이상, 4개 이하로 하세요.
    - 핵심 주제가 하나뿐이라면 **과감하게 1개만 생성**하세요.
    - 무의미하게 쪼개지 마세요.
    - 의미론적으로 연결된 내용은 같은 그룹에 포함하세요.
    - 작은 세부사항이나 예시는 별도 그룹으로 분리하지 말고 관련 주제 그룹에 포함하세요.
 
 9. 중요: 텍스트를 너무 잘게 쪼개지 마세요. 핵심 주제별로 크게 나누는 것이 중요합니다.
    - 예를 들어, 하나의 프로세스를 설명하는 여러 단계가 있다면, 각 단계를 별도 그룹으로 나누지 말고 전체 프로세스를 하나의 그룹으로 묶으세요.
    - 서로 관련된 개념이나 아이디어는 하나의 그룹으로 통합하세요.
 
 ${additionalMemory
         ? `
 10. 사용자가 특별히 기억하고 싶어하는 내용: \"${additionalMemory}\"\n   이 내용과 관련된 그룹을 우선적으로 생성하세요. 해당 문장이 들어간 그룹은 반드시 별도의 그룹으로 구분해 제목에 그 주제가 드러나야 합니다.
 `
         : ""
      }`;
}

/**
 * 기억 카드 생성을 위한 공통 프롬프트 부분 생성
 * @param additionalMemory 사용자가 기억하고 싶은 내용에 대한 선택적 입력
 * @returns 공통 프롬프트 문자열
 */
// function generateCommonChunksPromptParts(additionalMemory?: string): { intro: string, outro: string } {
// 주석 처리: 새로운 통합 프롬프트 함수 내에서 직접 구성
// ... (기존 generateCommonChunksPromptParts 내용)
// }

/**
 * 통합 형식 (Cloze + 일반) 기억 카드 생성을 위한 시스템 프롬프트
 * @param additionalMemory 사용자가 기억하고 싶은 내용에 대한 선택적 입력
 * @returns 시스템 프롬프트 문자열
 */
export function generateUnifiedChunksPrompt(additionalMemory?: string): string {
   // 수정: intro 문자열 내 ** 마크업 이스케이프 처리
   const intro = `당신은 학습과 기억력 향상을 극대화하는 효과적인 \'기억 카드\'를 만드는 전문가입니다. 다음 지침을 **절대적으로, 예외 없이 정확하게** 따라주세요:\n\n1. 주어진 텍스트 그룹에 대해, 가장 중요하고 기억할 만한 내용을 중심으로 **정확히 2~5개**의 \'기억 카드\'를 생성하세요. 오직 주어진 텍스트 내용만을 활용해야 하며, 절대 외부 정보를 추가하거나 내용을 변경하지 마세요.\n\n2. 반드시 다음 두 가지 유형의 카드를 **지정된 비율로 혼합**하여 생성해야 합니다:\n   - **Cloze 카드 (약 30~40% 비율):** 아래 3-1 형식 규칙을 **반드시** 따릅니다.\n   - **일반 카드 (질문/답변, 약 60~70% 비율):** 아래 3-2 형식 규칙을 **반드시** 따릅니다.\n\n3. 모든 카드는 아래 설명된 **매우 엄격한 형식**을 **100% 준수**해야 합니다:\n   - 각 카드는 반드시 \"카드 N: \"으로 시작합니다. (N은 1부터 시작하는 순차적 번호)\n   - 앞면과 뒷면은 반드시 ' / ' (슬래시 양쪽에 공백) 구분자를 사용합니다.\n\n   **3-1. Cloze 카드 형식 규칙 (★★★★★ 매우 중요 ★★★★★):**\n     - 앞면: 문장의 핵심 키워드 **하나 또는 두 개**를 {{}}로 감싼 **완전한 문장**. 반드시 **질문 형식이 아닌** **마침표(.)**로 끝나야 합니다.\n     - 뒷면: **가장 중요!!!** 앞면 문장에서 {{}} 표시만 \`** **\` (별표 두 개) 표시로 바꾼 것 외에는, **단 하나의 글자, 공백, 문장 부호도 다르지 않은 100% 동일한 문장**이어야 합니다. **절대로 내용을 요약하거나 단어를 바꾸거나 재구성하지 마세요.**.\n     - **Cloze 예시:** \"카드 N: {{간헐적 복습}}은 장기 기억 형성에 중요합니다. / **간헐적 복습**은 장기 기억 형성에 중요합니다.\" (앞면과 뒷면은 {{}} 와 **** 차이 외엔 완전히 동일함)\n\n   **3-2. 일반 카드 형식 규칙:**\n     - 앞면: 명확하고 구체적인 질문. 반드시 **물음표(?)**로 끝나야 합니다. 질문 내용 중 **가장 핵심적인 키워드**는 **반드시 \`** **\`로 감싸야 합니다**.\n     - 뒷면: 질문에 대한 간결하고 정확한 답변. 반드시 **마침표(.)**로 끝나야 합니다. 답변 내용 중 **가장 핵심적인 키워드** 역시 **반드시 \`** **\`로 감싸야 합니다**.\n     - **일반 카드 예시:** \"카드 N: **간헐적 복습**이 **장기 기억**에 효과적인 이유는 무엇인가요? / **간헐적 복습**은 망각 곡선을 고려하여 **장기 기억**을 강화하기 때문입니다.\" (앞면과 뒷면 모두 핵심 키워드에 볼드 처리 적용)\n     - (Explanation, Salience, Mnemonic 유형을 자연스럽게 포함시키세요.)\n\n4. 카드 생성 시 다음 5가지 원칙을 준수하세요:\n   - Focused: 하나의 명확한 개념 또는 사실에 집중\n   - Precise: 모호함 없이 정확하게\n   - Consistent: 일관된 스타일과 용어 사용\n   - Tractable: 너무 어렵거나 쉽지 않은 적절한 난이도\n   - Effortful: 단순 암기보다 이해와 회상을 유도`;

   // 수정: outro 템플릿 리터럴 구문 오류 수정 완료
   const outro = `5. 출력은 반드시 위에서 설명한 **매우 엄격한 형식**(\"카드 N: 앞면 / 뒷면\")만 포함해야 합니다. 각 카드는 반드시 새 줄로 구분하세요. 다른 어떤 종류의 설명, 머리말, 꼬리말도 **절대** 추가하면 안 됩니다.\n\n${additionalMemory
      ? `6. 사용자가 특별히 기억하고 싶어하는 내용: \"${additionalMemory}\"\n   이 내용과 관련된 기억 카드를 최소 1개 이상 반드시 포함시키세요. 해당 내용이 카드에서 명확히 드러나도록 작성해야 합니다.`
      : ''
      }`;

   return `${intro}\n\n${outro}`;
}